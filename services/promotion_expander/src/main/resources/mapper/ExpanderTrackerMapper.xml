<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.foodapp.promotion_expander.infra.persistence.repository.ExpanderTrackerRepository">

    <resultMap id="ExpanderTrackerResultMap" type="com.foodapp.promotion_expander.infra.persistence.entity.ExpanderTrackerEntity">
        <id property="promotionId" column="promotion_id"/>
        <result property="lastProcessedVersion" column="last_processed_version"/>
        <result property="updatedAt" column="updated_at"/>

        <result property="validStart" column="valid_start_date"/>
        <result property="validEnd" column="valid_end_date"/>
        <result property="coveredUntil" column="covered_until_date"/>

        <result property="status" column="status"/>

        <result property="rules" column="rules_json"
                typeHandler="com.foodapp.promotion_expander.infra.persistence.typehandler.PromotionRulesTypeHandler"/>
    </resultMap>

    <insert id="updateVersionIfNewer" parameterType="com.foodapp.promotion_expander.infra.persistence.entity.ExpanderTrackerEntity">
        INSERT INTO expander_tracker (
            promotion_id,
            last_processed_version,
            updated_at,
            valid_start_date,
            valid_end_date,
            covered_until_date,
            status,
            rules_json
        )
        VALUES (
                   #{promotionId},
                   #{lastProcessedVersion},
                   NOW(),
                   #{validStart},
                   #{validEnd},
                   #{coveredUntil},
                   #{status},
                   #{rules, typeHandler=com.foodapp.promotion_expander.infra.persistence.typehandler.PromotionRulesTypeHandler}
               )
            ON CONFLICT (promotion_id)
        DO UPDATE SET
            last_processed_version = #{lastProcessedVersion},
                           updated_at = NOW(),
                           valid_start_date = #{validStart},
                           valid_end_date = #{validEnd},
                           covered_until_date = #{coveredUntil},
                           status = #{status},
                           rules_json = #{rules, typeHandler=com.foodapp.promotion_expander.infra.persistence.typehandler.PromotionRulesTypeHandler}
           WHERE expander_tracker.last_processed_version &lt; #{lastProcessedVersion}
    </insert>

    <update id="updateCoveredUntil">
        UPDATE expander_tracker
        SET
            covered_until_date  = #{endDate},
            updated_at = NOW()
        WHERE promotion_id = #{promotionId}
    </update>

    <select id="findBatchNeedingExtension" resultMap="ExpanderTrackerResultMap">
        SELECT * FROM expander_tracker
        WHERE status = 'ACTIVE'
            AND (covered_until_date is NULL or covered_until_date &lt; #{targetHorizontal})
            AND (covered_until_date is NULL or covered_until_date &lt; valid_end_date)
        ORDER BY covered_until_date ASC NULLS FIRST
        LIMIT #{rollingBatchSize}
        FOR UPDATE SKIP LOCKED
    </select>

</mapper>