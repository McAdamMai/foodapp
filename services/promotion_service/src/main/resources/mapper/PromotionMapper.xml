<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.foodapp.promotion_service.persistence.repository.PromotionRepository">

    <!-- ResultMap -->
    <resultMap id="PromotionResultMap"
               type="com.foodapp.promotion_service.persistence.entity.PromotionEntity">
        <id property="id" column="id" typeHandler="com.foodapp.promotion_service.persistence.typehandler.UuidTypeHandler"/>
        <result property="name" column="name"/>
        <result property="description" column="description"/>
        <result property="status" column="status"
                typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result property="startDate" column="start_date"/>
        <result property="endDate" column="end_date"/>
        <result property="createAt" column="created_at"/>
        <result property="updateAt" column="updated_at"/>
        <result property="version" column="version"/>
        <result property="createdBy" column="created_by"/>
        <result property="reviewedBy" column="reviewed_by"/>
        <result property="publishedBy" column="published_by"/>
        <result property="templateId" column="template_id" typeHandler="com.foodapp.promotion_service.persistence.typehandler.UuidTypeHandler"/>
        <result property="rulesJson" column="rule_json"
                typeHandler="com.foodapp.promotion_service.persistence.typehandler.JsonPromotionRulesTypeHandler"/>
    </resultMap>

    <!-- SAVE -->
    <insert id="save">
        INSERT INTO promotion (
            id, name, description, status,
            start_date, end_date,
            created_at, updated_at,
            version,
            created_by, reviewed_by, published_by,
            template_id,
            rule_json
        )
        VALUES (
                   #{id, typeHandler=com.foodapp.promotion_service.persistence.typehandler.UuidTypeHandler}::uuid,
                   #{name},
                   #{description},
                   #{status, typeHandler=org.apache.ibatis.type.EnumTypeHandler},
                   #{startDate},
                   #{endDate},
                   #{createAt},
                   #{updateAt},
                   #{version},
                   #{createdBy},
                   #{reviewedBy},
                   #{publishedBy},
                   #{templateId, typeHandler=com.foodapp.promotion_service.persistence.typehandler.UuidTypeHandler}::uuid,
                   #{rulesJson, typeHandler=com.foodapp.promotion_service.persistence.typehandler.JsonPromotionRulesTypeHandler}::jsonb
               )
    </insert>

    <!-- UPDATE PROMOTION DETAILS -->
    <update id="updatePromotionDetails">
        UPDATE promotion
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="description != null">description = #{description},</if>
            <if test="startDate != null">start_date = #{startDate},</if>
            <if test="endDate != null">end_date = #{endDate},</if>
            <if test="rulesJson != null">
                rule_json = #{rulesJson, typeHandler=com.foodapp.promotion_service.persistence.typehandler.JsonPromotionRulesTypeHandler}::jsonb,
            </if>
            <if test="templateId != null">template_id = #{templateId, typeHandler=com.foodapp.promotion_service.persistence.typehandler.UuidTypeHandler}::uuid,</if>
            updated_at = NOW(),
            version = version + 1
        </set>
        WHERE id = #{id, typeHandler=com.foodapp.promotion_service.persistence.typehandler.UuidTypeHandler}::uuid
        AND version = #{version}
        AND status = 'PUBLISHED'
    </update>

    <!-- STATE TRANSITION -->
    <update id="updateStateTransition">
        UPDATE promotion
        <set>
            status = #{status},
            <if test="reviewedBy != null">reviewed_by = #{reviewedBy},</if>
            <if test="publishedBy != null">published_by = #{publishedBy},</if>
            updated_at = NOW(),
            version = version + 1
        </set>
        WHERE id = #{id, typeHandler=com.foodapp.promotion_service.persistence.typehandler.UuidTypeHandler}::uuid
        AND status = #{expectedStatus}
        AND version = #{version}
    </update>

    <!-- FIND BY ID -->
    <select id="findById" resultMap="PromotionResultMap">
        SELECT * FROM promotion
        WHERE id = #{id, typeHandler=com.foodapp.promotion_service.persistence.typehandler.UuidTypeHandler}::uuid
    </select>

    <!-- FIND ALL -->
    <select id="findAll" resultMap="PromotionResultMap">
        SELECT * FROM promotion ORDER BY created_at DESC
    </select>

</mapper>